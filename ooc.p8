pico-8 cartridge // http://www.pico-8.com
version 29
__lua__

dbg = true

ctrl = {
  out = false
}

-- player
-- todo: change from p1 to table full of actors
p1 = {}
-- sprite
p1.s = 80

-- time
t = 0

-- game state
gs = {}
gs.map = 0

-- game mode
-- 0: title
-- 1: gameplay
-- 2: ???
-- 3: ???
gs.mode = 1

-- sfx
snd = {
  step=0,
  thump=1,
  out_of_control=2,
  in_control=3,
  blip=4,
  chime=5,
}

-- map sprite
m = 0

-- map sprite flag
f = 0

function get_input()
  local last_x = p1.x
  local last_y = p1.y

  if ctrl.out then
    if btnp(0) then ctrl.x -= 1 end
    if btnp(1) then ctrl.x += 1 end
    if btnp(2) then ctrl.y -= 1 end
    if btnp(3) then ctrl.y += 1 end

    if btnp(0) or
      btnp(1) or
      btnp(2) or
      btnp(3) then

      sfx(snd["blip"])
    end


    if btnp(4) then
      ctrl.out = false

      sfx(snd["in_control"])
    end
  else
    if btnp(0) then p1.x -= 1 end
    if btnp(1) then p1.x += 1 end
    if btnp(2) then p1.y -= 1 end
    if btnp(3) then p1.y += 1 end

    if btnp(4) then
      ctrl.out = true
      ctrl.x = p1.x
      ctrl.y = p1.y

      sfx(snd["out_of_control"])
    end

    m = mget(p1.x, p1.y)
    f = fget(m)

    -- if wall is solid...
    if f == 1 then
      -- prevent player from moving into it
      p1.x = last_x
      p1.y = last_y

      sfx(snd["thump"])
    end

    if f == 128 then
      -- player hit the goal
      load_map(0)

      sfx(snd["chime"])
    end

    if p1.x != last_x or
    p1.y != last_y then
      sfx(snd["step"])
    end
  end
  
end

function load_map(i)
  -- load map based on index
  gs.map = i

  -- todo: spawn actors based on spawn tiles
  p1.x = 2
  p1.y = 2
end

function _init()
  load_map(0)
end

function _draw()
  cls()
  map(0, 0, 0, 0, 16, 16)
  spr(p1.s, p1.x * 8, p1.y * 8)

  if ctrl.out then
    spr(48, ctrl.x * 8 + 2, ctrl.y * 8 + 4 + sin(t/60)*1.5)
  end

  if dbg then
    -- print("time: "..t, 7)
  end

  local px = 1
  local py = 121

    if ctrl.out then
      print("out of control", px, py, 1)
    else
      print("controlling: p1", px, py, 7)
    end
end

function _update60()
  get_input()
  t += 1
end

__gfx__
00000000555555551111111111111111000000000000000000000000000000000000000077007700000000000000000000000000000000000000000000000000
00000000555555551111111111111111000000000000000000000000000000000000000077007700000000000000000000000000000000000000000000000000
00700700555555551111111111666611000000000000000000000000000000000000000000770077000000000000000000000000000000000000000000000000
00077000555555551111111111666611000000000000000000000000000000000000000000770077000000000000000000000000000000000000000000000000
00077000555555551111111111666611000000000000000000000000000000000000000077007700000000000000000000000000000000000000000000000000
00700700555555551111111111555511000000000000000000000000000000000000000077007700000000000000000000000000000000000000000000000000
00000000555555551111111111111111000000000000000000000000000000000000000000770077000000000000000000000000000000000000000000000000
00000000555555551111111111111111000000000000000000000000000000000000000000770077000000000000000000000000000000000000000000000000
11111111111111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111111111111111711111117111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11177711111771111117171111171711000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11171711111171111111171111111711000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11177711111171111111711111117111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11171111111171111117111111111711000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11171111111777111117771111177111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111111111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700000077007700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00777700070000700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00717170000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07717170000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07777770070000700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01777770077007700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00766700007777000077770000777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07777770077777700777777007777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777767777777667777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777767777777667777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07777770077777700777777007777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00777700007777000076670000777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00e88e0000eeee0000eeee0000eeee00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0eeeeee00eeeeee00eeeeee00eeeeee0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
eeeeeeeeeeeeeee8eeeeeeee8eeeeeee000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
eeeeeeeeeeeeeee8eeeeeeee8eeeeeee000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0eeeeee00eeeeee00eeeeee00eeeeee0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00eeee0000eeee0000e88e0000eeee00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00b33b0000bbbb0000bbbb0000bbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0bbbbbb00bbbbbb00bbbbbb00bbbbbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbb3bbbbbbbb3bbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbb3bbbbbbbb3bbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0bbbbbb00bbbbbb00bbbbbb00bbbbbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00bbbb0000bbbb0000b33b0000bbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00c11c0000cccc0000cccc0000cccc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0cccccc00cccccc00cccccc00cccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cccccccccccccccccccccccccccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ccccccccccccccc1cccccccc1ccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ccccccccccccccc1cccccccc1ccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cccccccccccccccccccccccccccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0cccccc00cccccc00cccccc00cccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00cccc0000cccc0000c11c0000cccc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0001000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020202020202020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020202020202020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020202020202020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020202020202020209020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020202020202020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020202020202020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020202020202020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020202020202020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020202020202020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020202020202020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020202020202020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020202020202020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020202020202020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
01010000026100f6102a6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
010400001101300003000030000300003000030000300003000030000300003000030000300003000030000300003000030000300003000030000300003000030000300003000030000300003000030000300003
010a00001d01528015240151f01500005000050000500005000050000500005000050000500005000050000500005000050000500005000050000500005000050000500005000050000500005000050000500005
0108000024115281151f1150010500105001050010500105001050010500105001050010500105001050010500105001050010500105001050010500105001050010500105001050010500100001000010000100
010200001801500005000050000500005000050000500005000050000500005000050000500005000050000500005000050000500005000050000500005000050000500005000050000500005000050000500005
010a000024055280552b0553705500005000050000500005000050000500005000050000500005000050000500005000050000500005000050000500005000050000500005000050000500000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000010061000600006000060000600006000c60000600136000060000600006000060000600006000060000600006000060000600006000060000600006000060000600006000060000600006000060000600
